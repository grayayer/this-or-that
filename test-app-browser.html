<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>App.js Browser Test</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
		}

		.test-section {
			margin: 20px 0;
			padding: 15px;
			border: 1px solid #ddd;
			border-radius: 5px;
		}

		.success {
			background-color: #d4edda;
			border-color: #c3e6cb;
		}

		.error {
			background-color: #f8d7da;
			border-color: #f5c6cb;
		}

		.info {
			background-color: #d1ecf1;
			border-color: #bee5eb;
		}

		button {
			background: #007bff;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 4px;
			cursor: pointer;
			margin: 5px;
		}

		button:hover {
			background: #0056b3;
		}

		pre {
			background: #f8f9fa;
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
		}
	</style>
</head>

<body>
	<h1>🧪 App.js Browser Integration Test</h1>

	<div class="test-section info">
		<h3>Test Status</h3>
		<div id="status">Loading dependencies...</div>
	</div>

	<div class="test-section">
		<h3>Actions</h3>
		<button onclick="testInitialization()">Test Initialization</button>
		<button onclick="testStateManagement()">Test State Management</button>
		<button onclick="testErrorHandling()">Test Error Handling</button>
		<button onclick="showAppState()">Show App State</button>
		<button onclick="resetApp()">Reset App</button>
	</div>

	<div class="test-section">
		<h3>Results</h3>
		<div id="results"></div>
	</div>

	<!-- Load dependencies -->
	<script src="js/data-validator.js"></script>
	<script src="js/app-data-loader.js"></script>
	<script src="js/app.js"></script>

	<script>
		let testResults = [];

		function log(message, type = 'info') {
			const timestamp = new Date().toLocaleTimeString();
			testResults.push(`[${timestamp}] ${message}`);
			updateResults();
			console.log(message);
		}

		function updateResults() {
			const resultsDiv = document.getElementById('results');
			resultsDiv.innerHTML = '<pre>' + testResults.slice(-20).join('\n') + '</pre>';
		}

		function updateStatus(message, type = 'info') {
			const statusDiv = document.getElementById('status');
			statusDiv.innerHTML = message;
			statusDiv.className = type;
		}

		// Test initialization
		async function testInitialization() {
			try {
				log('🚀 Testing app initialization...');

				const success = await initializeApp({
					dataPath: 'data/sample-designs.json',
					enableLogging: true
				});

				if (success) {
					log('✅ App initialized successfully');
					const status = getAppStatus();
					log(`📊 Loaded ${status.designCount} designs`);
					updateStatus('✅ App initialized and ready', 'success');
				} else {
					log('❌ App initialization failed');
					updateStatus('❌ App initialization failed', 'error');
				}
			} catch (error) {
				log(`❌ Initialization error: ${error.message}`);
				updateStatus(`❌ Error: ${error.message}`, 'error');
			}
		}

		// Test state management
		function testStateManagement() {
			try {
				log('🔍 Testing state management...');

				if (!isAppReady()) {
					log('⚠️ App not ready. Initialize first.');
					return;
				}

				const status = getAppStatus();
				log(`📊 Current status: ${JSON.stringify(status, null, 2)}`);

				const state = getAppState();
				log(`📋 State has ${state.designs.length} designs`);
				log(`📋 Current round: ${state.currentRound}`);
				log(`📋 Progress: ${status.progressPercentage.toFixed(1)}%`);

				log('✅ State management working correctly');
			} catch (error) {
				log(`❌ State management error: ${error.message}`);
			}
		}

		// Test error handling
		async function testErrorHandling() {
			try {
				log('🧪 Testing error handling...');

				// Test with invalid data
				try {
					await initializeApp({
						dataPath: 'data/non-existent.json',
						fallbackDataPath: 'data/also-non-existent.json',
						enableLogging: false
					});
					log('❌ Should have thrown error');
				} catch (error) {
					log('✅ Correctly handled missing data files');
				}

				// Test error state management
				handleAppError('Test error', 'Test context');
				const state = getAppState();
				if (state.error === 'Test error') {
					log('✅ Error state correctly set');
				}

				clearAppError();
				const clearedState = getAppState();
				if (clearedState.error === null) {
					log('✅ Error state correctly cleared');
				}

			} catch (error) {
				log(`❌ Error handling test failed: ${error.message}`);
			}
		}

		// Show current app state
		function showAppState() {
			try {
				const state = getAppState();
				const status = getAppStatus();

				log('📋 Current App State:');
				log(`   - Initialized: ${state.isInitialized}`);
				log(`   - Ready: ${status.isReady}`);
				log(`   - Loading: ${state.isLoading}`);
				log(`   - Error: ${state.error || 'None'}`);
				log(`   - Designs: ${state.designs.length}`);
				log(`   - Current Round: ${state.currentRound}`);
				log(`   - Total Rounds: ${state.totalRounds}`);
				log(`   - Progress: ${status.progressPercentage.toFixed(1)}%`);
				log(`   - Can Show Results: ${status.canShowResults}`);
			} catch (error) {
				log(`❌ Error showing state: ${error.message}`);
			}
		}

		// Reset app
		function resetApp() {
			try {
				log('🔄 Resetting application state...');
				resetApplicationState();
				log('✅ App state reset successfully');
				updateStatus('🔄 App state reset', 'info');
			} catch (error) {
				log(`❌ Reset error: ${error.message}`);
			}
		}

		// Initialize on page load
		window.addEventListener('load', async () => {
			try {
				// Validate dependencies
				const validation = validateDependencies();
				if (validation.isValid) {
					updateStatus('✅ All dependencies loaded', 'success');
					log('✅ All dependencies available');

					if (validation.warnings.length > 0) {
						log(`⚠️ Warnings: ${validation.warnings.join(', ')}`);
					}
				} else {
					updateStatus(`❌ Missing: ${validation.missing.join(', ')}`, 'error');
					log(`❌ Missing dependencies: ${validation.missing.join(', ')}`);
				}

				log('🎯 Ready for testing. Click buttons above to run tests.');
			} catch (error) {
				updateStatus(`❌ Setup error: ${error.message}`, 'error');
				log(`❌ Setup error: ${error.message}`);
			}
		});

		// Listen for app errors
		window.addEventListener('appError', (event) => {
			log(`🚨 App Error: ${event.detail.error} (Context: ${event.detail.context})`);
		});
	</script>
</body>

</html>