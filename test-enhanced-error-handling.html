<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Enhanced Error Handling Test</title>
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/responsive.css">
	<style>
		.test-container {
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
		}

		.test-section {
			margin-bottom: 30px;
			padding: 20px;
			border: 1px solid #e9ecef;
			border-radius: 8px;
		}

		.test-button {
			margin: 10px;
			padding: 10px 20px;
			background: #0066cc;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.test-button:hover {
			background: #0052a3;
		}

		.test-results {
			margin-top: 20px;
			padding: 15px;
			background: #f8f9fa;
			border-radius: 5px;
			font-family: monospace;
			white-space: pre-wrap;
		}
	</style>
</head>

<body>
	<div class="test-container">
		<h1>Enhanced Error Handling Test</h1>

		<div class="test-section">
			<h2>Data Loading Tests</h2>
			<button class="test-button" onclick="testValidDataLoad()">Test Valid Data Load</button>
			<button class="test-button" onclick="testInvalidDataLoad()">Test Invalid Data Load</button>
			<button class="test-button" onclick="testNetworkError()">Test Network Error</button>
			<button class="test-button" onclick="testOfflineMode()">Test Offline Mode</button>
			<div id="data-test-results" class="test-results"></div>
		</div>

		<div class="test-section">
			<h2>Image Loading Tests</h2>
			<button class="test-button" onclick="testImageLoadSuccess()">Test Image Load Success</button>
			<button class="test-button" onclick="testImageLoadFailure()">Test Image Load Failure</button>
			<button class="test-button" onclick="testImageRetry()">Test Image Retry</button>
			<div id="image-test-container" style="display: flex; gap: 20px; margin-top: 20px;">
				<!-- Test images will be inserted here -->
			</div>
			<div id="image-test-results" class="test-results"></div>
		</div>

		<div class="test-section">
			<h2>Error State Tests</h2>
			<button class="test-button" onclick="testBasicError()">Test Basic Error</button>
			<button class="test-button" onclick="testOfflineError()">Test Offline Error</button>
			<button class="test-button" onclick="testRetryableError()">Test Retryable Error</button>
			<button class="test-button" onclick="clearErrors()">Clear Errors</button>
		</div>

		<div class="test-section">
			<h2>Network Status Tests</h2>
			<button class="test-button" onclick="testNetworkMonitoring()">Test Network Monitoring</button>
			<button class="test-button" onclick="simulateOffline()">Simulate Offline</button>
			<button class="test-button" onclick="simulateOnline()">Simulate Online</button>
		</div>
	</div>

	<!-- Loading Section -->
	<section class="loading-section" id="loading-section" style="display: none;">
		<div class="loading-container">
			<div class="loading-spinner"></div>
			<p class="loading-text">Loading...</p>
		</div>
	</section>

	<!-- Error Section -->
	<section class="error-section" id="error-section" style="display: none;">
		<div class="error-container">
			<h3>Test Error</h3>
			<p class="error-message" id="error-message">Test error message</p>
			<button class="btn btn-primary" id="retry-btn">Try Again</button>
		</div>
	</section>

	<!-- Scripts -->
	<script src="js/data-validator.js"></script>
	<script src="js/app-data-loader.js"></script>
	<script src="js/app.js"></script>

	<script>
		let testResults = {
			data: '',
			image: ''
		};

		function log(message, type = 'data') {
			const timestamp = new Date().toLocaleTimeString();
			testResults[type] += `[${timestamp}] ${message}\n`;
			document.getElementById(`${type}-test-results`).textContent = testResults[type];
		}

		// Data Loading Tests
		async function testValidDataLoad() {
			log('Testing valid data load...');
			try {
				const loader = new AppDataLoader();
				const data = await loader.loadDesignsWithOfflineSupport('data/sample-designs.json', {
					onProgress: (info) => log(`Progress: ${info.message}`)
				});
				log(`✅ Success: Loaded ${data.designs.length} designs`);
			} catch (error) {
				log(`❌ Error: ${error.message}`);
			}
		}

		async function testInvalidDataLoad() {
			log('Testing invalid data load...');
			try {
				const loader = new AppDataLoader();
				const data = await loader.loadDesignsWithOfflineSupport('data/non-existent.json', {
					maxRetries: 2,
					onProgress: (info) => log(`Progress: ${info.message}`)
				});
				log(`✅ Unexpected success: ${data.designs.length} designs`);
			} catch (error) {
				log(`❌ Expected error: ${error.message}`);
			}
		}

		async function testNetworkError() {
			log('Testing network error simulation...');
			try {
				// Simulate network error by using invalid URL
				const loader = new AppDataLoader();
				const data = await loader.loadDesignsWithOfflineSupport('https://invalid-domain-12345.com/data.json', {
					maxRetries: 2,
					retryDelay: 500,
					onProgress: (info) => log(`Progress: ${info.message}`)
				});
				log(`✅ Unexpected success`);
			} catch (error) {
				log(`❌ Expected network error: ${error.message}`);
			}
		}

		async function testOfflineMode() {
			log('Testing offline mode...');

			// First, save some data to cache
			const loader = new AppDataLoader();
			try {
				const data = await loader.loadDesigns('data/sample-designs.json');
				loader.saveToCache('data/sample-designs.json', data);
				log('✅ Data saved to cache');

				// Now try to load with simulated network failure
				const cachedData = loader.loadFromCache('data/sample-designs.json');
				if (cachedData) {
					log(`✅ Successfully loaded from cache: ${cachedData.designs.length} designs`);
				} else {
					log('❌ No cached data available');
				}
			} catch (error) {
				log(`❌ Cache test error: ${error.message}`);
			}
		}

		// Image Loading Tests
		function testImageLoadSuccess() {
			log('Testing successful image load...', 'image');
			const container = createTestImageContainer();
			const img = container.querySelector('img');

			const testDesign = {
				id: 'test-success',
				image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNGRhNmZmIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5UZXN0IEltYWdlPC90ZXh0Pjwvc3ZnPg==',
				title: 'Test Success Image'
			};

			setupImageElement(img, testDesign, container);
			log('✅ Image setup completed', 'image');
		}

		function testImageLoadFailure() {
			log('Testing image load failure...', 'image');
			const container = createTestImageContainer();
			const img = container.querySelector('img');

			const testDesign = {
				id: 'test-failure',
				image: 'https://invalid-domain-12345.com/invalid-image.jpg',
				title: 'Test Failure Image'
			};

			setupImageElement(img, testDesign, container);
			log('✅ Image failure test setup completed', 'image');
		}

		function testImageRetry() {
			log('Testing image retry functionality...', 'image');
			const container = createTestImageContainer();
			const img = container.querySelector('img');

			// First load a failing image
			const testDesign = {
				id: 'test-retry',
				image: 'https://invalid-domain-12345.com/invalid-image.jpg',
				title: 'Test Retry Image'
			};

			setupImageElement(img, testDesign, container);

			// After 3 seconds, simulate retry with valid image
			setTimeout(() => {
				log('Simulating retry with valid image...', 'image');
				testDesign.image = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjhhNzQ1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5SZXRyeSBTdWNjZXNzPC90ZXh0Pjwvc3ZnPg==';
				setupImageElement(img, testDesign, container);
			}, 3000);
		}

		function createTestImageContainer() {
			const container = document.createElement('div');
			container.className = 'image-option';
			container.style.cssText = 'width: 200px; height: 150px; border: 1px solid #ccc; position: relative;';

			const img = document.createElement('img');
			img.className = 'design-image';
			img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

			container.appendChild(img);
			document.getElementById('image-test-container').appendChild(container);

			return container;
		}

		// Error State Tests
		function testBasicError() {
			showEnhancedErrorState('This is a test error message for demonstration purposes.', {
				showRetryButton: true,
				showRefreshButton: true,
				retryCallback: () => {
					alert('Retry button clicked!');
					hideErrorState();
				}
			});
		}

		function testOfflineError() {
			showEnhancedErrorState('You appear to be offline. Please check your internet connection.', {
				showRetryButton: true,
				showRefreshButton: true,
				showOfflineMessage: true,
				retryCallback: () => {
					alert('Offline retry clicked!');
					hideErrorState();
				}
			});
		}

		function testRetryableError() {
			let retryCount = 0;
			const maxRetries = 3;

			const attemptRetry = () => {
				retryCount++;
				if (retryCount < maxRetries) {
					showEnhancedErrorState(`Retry attempt ${retryCount}/${maxRetries} failed. Network timeout occurred.`, {
						showRetryButton: true,
						showRefreshButton: true,
						retryCallback: attemptRetry
					});
				} else {
					showEnhancedErrorState('All retry attempts failed. Please refresh the page.', {
						showRetryButton: false,
						showRefreshButton: true
					});
				}
			};

			attemptRetry();
		}

		function clearErrors() {
			hideErrorState();
		}

		// Network Status Tests
		function testNetworkMonitoring() {
			setupNetworkMonitoring();
			alert('Network monitoring initialized. Check the top-right corner for status indicator.');
		}

		function simulateOffline() {
			// Dispatch offline event
			window.dispatchEvent(new Event('offline'));
			alert('Simulated offline event dispatched');
		}

		function simulateOnline() {
			// Dispatch online event
			window.dispatchEvent(new Event('online'));
			alert('Simulated online event dispatched');
		}

		// Initialize on page load
		document.addEventListener('DOMContentLoaded', function () {
			log('Enhanced Error Handling Test Page Loaded');
			log('Click buttons above to test different error scenarios', 'image');
		});
	</script>
</body>

</html>